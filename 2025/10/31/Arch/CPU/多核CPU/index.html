<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="keywords" content="Hexo Theme Redefine"><meta name="author" content="zyu"><script>!function(){const e="dark";function t(t){const o=t===e,c=document.documentElement;c.setAttribute("data-theme",t),c.classList.add(t),c.classList.remove(o?"light":e),c.style.colorScheme=t}const o=function(){try{const t=localStorage.getItem("REDEFINE-THEME-STATUS");if(t){const{isDark:o}=JSON.parse(t);return o?e:"light"}}catch(e){}return matchMedia("(prefers-color-scheme: dark)").matches?e:"light"}();t(o),matchMedia("(prefers-color-scheme: dark)").addEventListener("change",({matches:o})=>{localStorage.getItem("REDEFINE-THEME-STATUS")||t(o?e:"light")}),"loading"!==document.readyState?document.body.classList.add(o+"-mode"):document.addEventListener("DOMContentLoaded",()=>{document.body.classList.add(o+"-mode"),document.body.classList.remove((o===e?"light":e)+"-mode")})}()</script><style>:root[data-theme=dark]{--background-color:#202124;--background-color-transparent:rgba(32, 33, 36, 0.6);--second-background-color:#2d2e32;--third-background-color:#34353a;--third-background-color-transparent:rgba(32, 33, 36, 0.6);--primary-color:#0066CC;--first-text-color:#ffffff;--second-text-color:#eeeeee;--third-text-color:#bebec6;--fourth-text-color:#999999;--default-text-color:#bebec6;--invert-text-color:#373D3F;--border-color:rgba(255, 255, 255, 0.08);--selection-color:#0066CC;--shadow-color-1:rgba(255, 255, 255, 0.08);--shadow-color-2:rgba(255, 255, 255, 0.05)}:root[data-theme=light]{--background-color:#fff;--background-color-transparent:rgba(255, 255, 255, 0.6);--second-background-color:#f8f8f8;--third-background-color:#f2f2f2;--third-background-color-transparent:rgba(241, 241, 241, 0.6);--primary-color:#0066CC;--first-text-color:#16171a;--second-text-color:#2f3037;--third-text-color:#5e5e5e;--fourth-text-color:#eeeeee;--default-text-color:#373D3F;--invert-text-color:#bebec6;--border-color:rgba(0, 0, 0, 0.08);--selection-color:#0066CC;--shadow-color-1:rgba(0, 0, 0, 0.08);--shadow-color-2:rgba(0, 0, 0, 0.05)}body{background-color:var(--background-color);color:var(--default-text-color)}:root[data-theme=dark] body{background-color:var(--background-color);color:var(--default-text-color)}</style><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="canonical" href="http://example.com/2025/10/31/arch/cpu/多核cpu/"><meta name="robots" content="index,follow"><meta name="googlebot" content="index,follow"><meta name="revisit-after" content="1 days"><meta name="description" content="Journey."><meta property="og:type" content="article"><meta property="og:title" content="现代CPU"><meta property="og:url" content="http://example.com/2025/10/31/Arch/CPU/%E5%A4%9A%E6%A0%B8CPU/index.html"><meta property="og:site_name" content="Hexo"><meta property="og:description" content="Journey."><meta property="og:locale" content="en_US"><meta property="og:image" content="http://example.com/images/redefine-og.webp"><meta property="article:published_time" content="2025-10-31T00:00:00.000Z"><meta property="article:modified_time" content="2025-11-07T10:21:57.148Z"><meta property="article:author" content="John Doe"><meta property="article:tag" content="Tech"><meta property="article:tag" content="achitechture"><meta property="article:tag" content="CPU"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://example.com/images/redefine-og.webp"><link rel="icon" type="image/png" href="/images/website/icon.png" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="/images/website/icon.png"><meta name="theme-color" content="#BACCD9"><link rel="shortcut icon" href="/images/website/icon.png"><title>现代CPU | zyu&#39;s blog</title><link rel="stylesheet" href="/fonts/Chillax/chillax.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/build/tailwind.css"><link rel="stylesheet" href="/fonts/GeistMono/geist-mono.css"><link rel="stylesheet" href="/fonts/Geist/geist.css"><link href="" rel="stylesheet"><script id="hexo-configurations">window.config={hostname:"example.com",root:"/",language:"en"},window.theme={articles:{style:{font_size:"16px",line_height:1.5,image_border_radius:"14px",image_alignment:"center",image_caption:!1,link_icon:!0,delete_mask:!1,title_alignment:"left",headings_top_spacing:{h1:"3.2rem",h2:"2.4rem",h3:"1.9rem",h4:"1.6rem",h5:"1.4rem",h6:"1.3rem"}},word_count:{enable:!0,count:!0,min2read:!0},author_label:{enable:!0,auto:!1,list:[]},code_block:{copy:!0,style:"mac",highlight_theme:{light:"github",dark:"vs2015"},font:{enable:!1,family:null,url:null}},toc:{enable:!0,max_depth:3,number:!1,expand:!0,init_open:!0},copyright:{enable:!0,default:"cc_by_nc_sa"},lazyload:!0,pangu_js:!1,recommendation:{enable:!1,title:"推荐阅读",limit:3,mobile_limit:2,placeholder:"/images/wallhaven-wqery6-light.webp",skip_dirs:[]}},colors:{primary:"#BACCD9",secondary:null,default_mode:"light"},global:{fonts:{chinese:{enable:!0,family:null,url:null},english:{enable:!1,family:null,url:null},title:{enable:!1,family:null,url:null}},content_max_width:"1000px",sidebar_width:"210px",hover:{shadow:!0,scale:!1},scroll_progress:{bar:!1,percentage:!0},website_counter:{url:"https://cn.vercount.one/js",enable:!0,site_pv:!0,site_uv:!0,post_pv:!0},single_page:!0,preloader:{enable:!1,custom_message:null},side_tools:{gear_rotation:!0,auto_expand:!1},open_graph:{enable:!0,image:"/images/redefine-og.webp",description:"Journey."},google_analytics:{enable:!1,id:null}},home_banner:{enable:!1,style:"fixed",image:{light:"/images/wallhaven-wqery6-light.webp",dark:"/images/wallhaven-wqery6-dark.webp"},title:"sleep time",subtitle:{text:[],hitokoto:{enable:!1,show_author:!1,api:"https://v1.hitokoto.cn"},typing_speed:100,backing_speed:80,starting_delay:500,backing_delay:1500,loop:!0,smart_backspace:!0},text_color:{light:"#fff",dark:"#d1d1b6"},text_style:{title_size:"2.8rem",subtitle_size:"1.5rem",line_height:1.2},custom_font:{enable:!1,family:null,url:null},social_links:{enable:!1,style:"default",links:{github:null,instagram:null,zhihu:null,twitter:null,email:null},qrs:{weixin:null}}},plugins:{feed:{enable:!0},aplayer:{enable:!0,type:"fixed",audios:[{name:null,artist:null,url:null,cover:null,lrc:null}]},mermaid:{enable:!0,version:"11.4.1"}},version:"2.8.5",navbar:{auto_hide:!1,color:{left:"#f78736",right:"#367df7",transparency:35},width:{home:"1200px",pages:"1000px"},links:{Home:{path:"/",icon:"fa-regular fa-house"},Archives:{path:"/archives",icon:"fa-regular fa-archive"}},search:{enable:!0,preload:!0}},page_templates:{friends_column:2,tags_style:"blur"},home:{sidebar:{enable:!0,position:"left",first_item:"menu",announcement:null,show_on_mobile:!0,links:{Tags:{path:"/tags",icon:"fa-regular fa-tags"}}},article_date_format:"auto",excerpt_length:200,categories:{enable:!0,limit:3},tags:{enable:!0,limit:3}},footerStart:"2022/8/17 11:45:14"},window.lang_ago={second:"%s seconds ago",minute:"%s minutes ago",hour:"%s hours ago",day:"%s days ago",week:"%s weeks ago",month:"%s months ago",year:"%s years ago"},window.data={masonry:!1}</script><link rel="stylesheet" href="/fontawesome/fontawesome.min.css"><link rel="stylesheet" href="/fontawesome/brands.min.css"><link rel="stylesheet" href="/fontawesome/solid.min.css"><link rel="stylesheet" href="/fontawesome/regular.min.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div class="progress-bar-container"><span class="pjax-progress-bar"></span></div><main class="page-container" id="swup"><div class="main-content-container flex flex-col justify-between min-h-dvh"><div class="main-content-header"><header class="navbar-container px-6 md:px-12"><div class="navbar-content transition-navbar"><div class="left"><a class="logo-image h-8 w-8 sm:w-10 sm:h-10 mr-3" href="/"><img src="/images/website/logo.jpg" class="w-full h-full rounded-xs"> </a><a class="logo-title" href="/">zyu&#39;s blog</a></div><div class="right"><div class="desktop"><ul class="navbar-list"><li class="navbar-item"><a href="/"><i class="fa-regular fa-house fa-fw"></i> HOME</a></li><li class="navbar-item"><a href="/archives"><i class="fa-regular fa-archive fa-fw"></i> ARCHIVES</a></li><li class="navbar-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></li></ul></div><div class="mobile"><div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></div><div class="icon-item navbar-bar"><div class="navbar-bar-middle"></div></div></div></div></div><div class="navbar-drawer h-dvh w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between"><ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start"><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full" href="/"><span>HOME </span><i class="fa-regular fa-house fa-sm fa-fw"></i></a></li><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full" href="/archives"><span>ARCHIVES </span><i class="fa-regular fa-archive fa-sm fa-fw"></i></a></li><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active" href="/tags"><span>Tags</span> <i class="fa-regular fa-tags fa-sm fa-fw"></i></a></li></ul><div class="statistics flex justify-around my-2.5"><a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags"><div class="number text-2xl sm:text-xl text-second-text-color font-semibold">22</div><div class="label text-third-text-color text-sm">Tags</div></a><a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories"><div class="number text-2xl sm:text-xl text-second-text-color font-semibold">0</div><div class="label text-third-text-color text-sm">Categories</div></a><a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives"><div class="number text-2xl sm:text-xl text-second-text-color font-semibold">15</div><div class="label text-third-text-color text-sm">Posts</div></a></div></div><div class="window-mask"></div></header></div><div class="main-content-body transition-fade-up"><div class="main-content"><div class="post-page-container flex relative justify-between box-border w-full h-full"><div class="article-content-container"><div class="article-title relative w-full"><div class="w-full flex items-center pt-6 justify-start"><h1 class="article-title-regular text-second-text-color tracking-tight text-4xl md:text-6xl font-semibold px-2 sm:px-6 md:px-8 py-3">现代CPU</h1></div></div><div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8"><div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]"><img src="/images/website/racket.png"></div><div class="info flex flex-col justify-between"><div class="author flex items-center"><span class="name text-default-text-color text-lg font-semibold">zyu</span> <span class="author-label ml-1.5 text-xs px-2 py-0.5 rounded-small text-third-text-color border border-shadow-color-1">Lv2</span></div><div class="meta-info"><div class="article-meta-info"><span class="article-date article-meta-item"><i class="fa-regular fa-pen-fancy"></i>&nbsp; <span class="desktop">2025-10-31</span> <span class="mobile">2025-10-31</span> <span class="hover-info">Created</span> </span><span class="article-date article-meta-item"><i class="fa-regular fa-wrench"></i>&nbsp; <span class="desktop">2025-11-07 10:21:57</span> <span class="mobile">2025-11-07 10:21:57</span> <span class="hover-info">Updated</span> </span><span class="article-tags article-meta-item"><i class="fa-regular fa-tags"></i>&nbsp;<ul><li><a href="/tags/Tech/">Tech</a>&nbsp;</li><li>| <a href="/tags/achitechture/">achitechture</a>&nbsp;</li><li>| <a href="/tags/CPU/">CPU</a>&nbsp;</li></ul></span><span class="article-pv article-meta-item"><i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span></span></div></div></div></div><div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8"><h1 id="多核互联"><a href="#多核互联" class="headerlink" title="多核互联"></a>多核互联</h1><p>单核性能提升面临瓶颈，多核架构成了必然的选择。多核之间的通信，内存访问就成了设计的重要点，对于内存的访问，UMA和NUMA先后出现</p><h2 id="SMP"><a href="#SMP" class="headerlink" title="SMP"></a>SMP</h2><p>UMA（Uniform Memory Access，统一内存访问）架构，也称为SMP（Symmetric Multi-Processing，对称多处理）架构，CPU通过前端总线（FSB，Front Side Bus）连接到北桥芯片（NorthBridge），然后北桥芯片连接到内存，内存控制器集成在北桥芯片里面。<br>所有CPU共享一个单独的内存控制器。当所有CPU同时访问内存时，这个内存控制器常常成为性能瓶颈。同时单独的内存控制器能够管理的内存大小也是有限的。</p><h2 id="NUMA"><a href="#NUMA" class="headerlink" title="NUMA"></a>NUMA</h2><p>把内存控制器集成在CPU内部，由CPU来直接管理和访问内存。NUMA架构下，每个node都有自己独立的内存控制器和CPU core。</p><h3 id="硬件"><a href="#硬件" class="headerlink" title="硬件"></a>硬件</h3><p>物理上，Socket通常包含一个完整的处理器芯片。每个socket通过内存控制器连接本地内存（local memory），<strong>每个Socket通常对应一个NUMA节点</strong><br>Die（芯片裸片）是半导体制造中的基本单位，指的是在硅晶圆上制造的单个集成电路芯片，一个Die如下图所示，每个socket由全相连的die构成（一般四个），AMD的Die直接通过片外总线Infinity Fabric(下图蓝色)进行连接而Intel是通过QPI<br><img lazyload src="/images/loading.svg" data-src="https://cloudflare-imgbed-4ea.pages.dev/file/Arch/CPU/1761969430954_AMD_EPYC_Die.png" alt="AMD EPYC Die.png"></p><h3 id="核心互联"><a href="#核心互联" class="headerlink" title="核心互联"></a>核心互联</h3><h4 id="Intel"><a href="#Intel" class="headerlink" title="Intel"></a>Intel</h4><p><strong>Ringbus</strong><br>Ringbus给消费级CPU使用 核心通过一条环形总线互联通信，在Die上面可以看到L1,L2缓存是核心独有的，三级缓存L3（或者last level cache）通过总线（ringbus）被连起来了，但实际上是被<strong>切分</strong>掉了</p><ul><li>L1 cache FLC包含指令和数据(ICU和DCU)</li><li>L2 cache(MLC)在skylake中放到core外</li><li>L3 cache(LLC)</li></ul><img lazyload src="/images/loading.svg" data-src="https://cloudflare-imgbed-4ea.pages.dev/file/Arch/CPU/1761970603921_image.png" alt="image.png" width="70%"><p>如下图，核心也不一定是在Die中均匀分布的，虽然逻辑表示上是通过cluster均匀分开的</p><img lazyload src="/images/loading.svg" data-src="https://cloudflare-imgbed-4ea.pages.dev/file/Arch/CPU/1761971053824_cache_hierarchy.png" alt="cache_hierarchy.png" width="70%"><p><strong>Mesh</strong><br>Mesh现在新产品似乎不再采用了，处理器核心、缓存控制器和内存控制器通过二维网格状网络连接，将一个Socket内的资源划分为多个逻辑NUMA域，每个子域有相对独立的内存控制器访问路径<br><img lazyload src="/images/loading.svg" data-src="https://cloudflare-imgbed-4ea.pages.dev/file/Arch/CPU/1761970651425_image.png" alt="image.png" width="70%"></p><h4 id="AMD"><a href="#AMD" class="headerlink" title="AMD"></a>AMD</h4><p><strong>Infinity Fabric</strong></p><h3 id="NUMA互联"><a href="#NUMA互联" class="headerlink" title="NUMA互联"></a>NUMA互联</h3><p>NUMA互联中，Intel则是通过UPI进行连接，跨NUMA的访问请求都是通过UPI访问到对端</p><h3 id="NUMA-访存"><a href="#NUMA-访存" class="headerlink" title="NUMA 访存"></a>NUMA 访存</h3><ul><li>本NUMA的CPU通过访问三级缓存（未命中），到本地的内存控制器（解析内存地址），最后通过互联总线把内存访问请求发给另一端NUMA的内存控制器</li></ul><h1 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h1><h2 id="缓存一致性"><a href="#缓存一致性" class="headerlink" title="缓存一致性"></a>缓存一致性</h2><p>X86、ARM和Power系列的Cache Coherency的原始模型都出自MESI protocol<br>缓存一致性是针对L3 cache的 因为L3cache才是共享的</p><ul><li><strong>状态实现</strong> ：cache line的几个字节用于表示状态</li><li><strong>状态同步</strong>： ringbus上发送snoop消息，snoop消息在QPI总线上广播，带宽消耗很大</li><li><strong>状态监控</strong>： 在L3 cache处的就是Cache Agent(CA)<br>在内存控制器处的就是Home Agent(HA) ，下图通过HA实现snoop消息传播</li></ul><img lazyload src="/images/loading.svg" data-src="https://cloudflare-imgbed-4ea.pages.dev/file/Arch/CPU/1761978085420_cache_hierarchiy_agent.png" alt="cache hierarchiy agent.png" width="70%"><blockquote><p>Intel每一代都在优化Snoop模型，有许多新的机制被引入，并结合Directory，来减小整体的overhead。尽管如此,snoop消耗的QPI带宽依然很高，这在8路变成16路甚至32路时会占据大量带宽，在很多情况下会让更多路变大得不偿失。(way也就是socket)</p></blockquote><h3 id="伪共享问题"><a href="#伪共享问题" class="headerlink" title="伪共享问题"></a>伪共享问题</h3><p>多个CPU核心访问不同的数据，但这些数据恰好位于同一个缓存行（Cache Line）中，导致缓存行在不同核心间频繁传输，由于缓存一致性的约束，会频繁触发广播，刷入刷出缓存</p><p><strong>如何减少伪共享问题</strong></p><ul><li>很显然，我们只需要让他们不在一个缓存行即可，间隔两个缓存行是最为保险的（可能有预取问题）</li></ul><h2 id="缓存相关"><a href="#缓存相关" class="headerlink" title="缓存相关"></a>缓存相关</h2><p><strong>缓存是如何查询的</strong><br>缓存贵在它可以同时多路匹配，因此不需要像内存一样依次匹配</p><h3 id="缓存存储的是什么地址"><a href="#缓存存储的是什么地址" class="headerlink" title="缓存存储的是什么地址"></a>缓存存储的是什么地址</h3><ul><li><strong>VIVT (Virtually Indexed, Virtually Tagged)</strong>：使用虚拟地址索引和标记</li><li><strong>VIPT (Virtually Indexed, Physically Tagged)</strong>：使用虚拟地址索引，物理地址标记</li><li><strong>PIPT (Physically Indexed, Physically Tagged)</strong>：使用物理地址索引和标记<br>L1常用VIPT，L2&#x2F;L3常用PIPT</li></ul><h1 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h1><p>IMC（Integrated Memory Controller） 集成内存控制器 所以可以看到上面连接有DDR4<br>Intel将快速IO设备集成到CPU内部，换种说法就是北桥被集成到CPU中，其中包含<br>1. IMC<br>2. PCIE root，也就是说PICe设备也需要考虑NUMA的事情<br>Channel是内存控制器与内存模块之间的独立数据传输路径，每个channel提供独立的内存带宽，多个channel可以并行工作<br>DPC (DIMM Per Channel)，DPC表示每个内存通道上安装的DIMM（内存条）数量</p><ul><li><strong>1DPC</strong>：每个通道安装1根内存条</li><li><strong>2DPC</strong>：每个通道安装2根内存条，同一个channel上的两个DIMM是<strong>共享同一组数据总线、地址总线和控制信号</strong><br>这两个代表了内存速度和内存容量的限制，2DPC配置通常需要降低内存频率运行，同时因为同一时刻只能有一个内存条被访问<blockquote><p>有些可能内存插错了，比如只是想用1DPC结果，插成2DPC使得访存时延更高</p></blockquote></li></ul><h2 id="NUMA内存管理"><a href="#NUMA内存管理" class="headerlink" title="NUMA内存管理"></a>NUMA内存管理</h2><p>操作系统提供对应的策略：优先本地内存，在实际操作中，比如常用的Arena内存管理并不会主动考虑NUMA实现，而是依赖操作系统的内存感知，可能导致交织访问，内核采用带k字的分配函数（如kmalloc）即得到连续的物理内存，而使用v开头的分配函数，如vmalloc，则不能保证。<br>当然实际上，分配内存也是先分配虚拟地址<br><strong>如果不断分配虚拟地址，会发生什么</strong></p><ul><li>分配虚拟地址，会先准备一段物理地址，分配响应的元数据（比如页表）</li><li>虚拟地址超出进程限制<br>此时看哪个的先到达上限</li></ul><h1 id="单核"><a href="#单核" class="headerlink" title="单核"></a>单核</h1><h2 id="流水线"><a href="#流水线" class="headerlink" title="流水线"></a>流水线</h2><p>RISC(精简指令)指令流水线包含取指（IF），译码 (Instruction Decode, ID)，执行，访存，写回<br><img lazyload src="/images/loading.svg" data-src="https://pic3.zhimg.com/v2-cbc87fc5c7d840b6669750d3f5c2dff8_1440w.jpg" alt="图片"></p><h3 id="前端"><a href="#前端" class="headerlink" title="前端"></a>前端</h3><p>CPU前端是处理器流水线的前半部分，负责<strong>取指令、解码和分发</strong>等操作，其中处理顺序是按序 (In-Order)<br>目标： 不断地取指，发送给后端</p><h4 id="取指"><a href="#取指" class="headerlink" title="取指"></a>取指</h4><p>CPU 必须从内存（或高速缓存 L1&#x2F;L2&#x2F;L3 Cache）中把程序指令取到 CPU 内部。<br><strong>分支预测</strong>：遇到if这类分支语句CPU会“猜测”一条最可能执行的路径（比如，<code>if</code> 成立），然后沿着这条路继续取指。如果猜错了，前端会清空已取的指令，重新开始，这被称为“流水线冲刷”</p><h4 id="解码"><a href="#解码" class="headerlink" title="解码"></a>解码</h4><p>计算机指令（例如 x86 指令集）的长度和复杂度各不相同。解码器会将这些“复杂指令”翻译成 CPU 内部更容易处理的、长度固定的“简单指令”，称为微操作 (Micro-operations）</p><blockquote><p>指令集更适合人类阅读</p></blockquote><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ADD [memory], EAX</span><br><span class="line">// 解码为</span><br><span class="line">LOAD</span><br><span class="line">ADD</span><br><span class="line">STORE</span><br></pre></td></tr></table></figure></div><p><strong>重命名</strong>：很多指令会重复使用同一个寄存器（比如 <code>EAX</code>），重命名器会给每个微操作分配一个临时的、唯一的<strong>物理寄存器</strong> 接触指令的依赖关系</p><h3 id="后端"><a href="#后端" class="headerlink" title="后端"></a>后端</h3><p>后端接收来自前端的微操作(μops)，并将其调度到各种执行单元进行实际的计算和内存操作。处理顺序是乱序的</p><h4 id="调度"><a href="#调度" class="headerlink" title="调度"></a>调度</h4><p>微操作从前端被“发射”（Dispatch）到后端的保留站 (Reservation Stations, RS)。微操作会在这里等待它的“操作数”（需要的数据）准备就绪</p><h4 id="执行"><a href="#执行" class="headerlink" title="执行"></a>执行</h4><p>指令数据准备完毕，发送到对应的执行单元 (Execution Unit, EU)。对应的被称为port</p><h4 id="写回-提交"><a href="#写回-提交" class="headerlink" title="写回&amp;提交"></a>写回&amp;提交</h4><p>微操作在执行完毕后（乱序的），其结果并不会马上“生效”，而是先存放在重排序缓冲区 (ROB) 中<br>只有当一个微操作是“最老”的且已经执行完毕，它的结果才会被提交 (Commit)正式写入寄存器</p><h2 id="IPC"><a href="#IPC" class="headerlink" title="IPC"></a>IPC</h2><p>CPU每个周期执行的指令数量，理想的指令执行流水线中，每个阶段都是一个时钟周期，但实际并不是<br>由CPU的架构，其实我们可以看到IPC受制于前后端，前端能解析多少指令，后端能执行多少指令<br>首先后端有多少port</p><ul><li>通常是解码宽度 (Decode Width)和提交宽度 (Retire Width，有多少个port)决定。<blockquote><p>AMD Zen 4 (Ryzen 7000)： 其 P-Core（高性能核心）是一个 4-wide 的解码和 4-wide 的提交设计（尽管其后端执行能力更宽），所以其理论峰值 IPC 通常被认为是 4.0。<br>Apple M1&#x2F;M2&#x2F;M3 (Firestorm&#x2F;Everest)： 其 P-Core 拥有的 8-wide 解码器和 8-wide 提交能力，因此其理论峰值 IPC 为 8.0。</p></blockquote></li></ul><h2 id="如何提升CPU性能"><a href="#如何提升CPU性能" class="headerlink" title="如何提升CPU性能"></a>如何提升CPU性能</h2><p>我们期望让CPU执行更多指令，但是IPC是相对指标，因为CPU周期不是固定，IPC需要乘以CPS(cycles per second)实际上就是频率<br>$$IPC \times Frequency$$</p><blockquote><p>3.0 GHz 代表每秒30亿个时钟周期</p></blockquote><h3 id="提高频率"><a href="#提高频率" class="headerlink" title="提高频率"></a>提高频率</h3><ul><li>需要更高的CPU电压，但是电压更高，发热量更高<br>CPU的标定频率用于说明多核能保证的频率，而最大频率是指该CPU单核上能达到的，其他核心基本休眠等<br>现有的CPU通常采用智能调频的方式，在负载低时降频来省电和减少发热</li></ul><h3 id="提高IPC"><a href="#提高IPC" class="headerlink" title="提高IPC"></a>提高IPC</h3><h4 id="前端-1"><a href="#前端-1" class="headerlink" title="前端"></a>前端</h4><p><strong>提高分支预测准确度</strong><br>在编译器中，默认选择最短的分支语句作为预取<br>或者自己手动设置</p><div class="code-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">__builtin_expect</span><br><span class="line">likely</span><br></pre></td></tr></table></figure></div><ul><li>尽量不要让一些较少的校验判断放在前面干扰CPU分支预测<br><strong>指令缓存命中率高</strong><br>比如存在数据依赖，或者指令prefetch失败，这种情况多出现在有跳转的</li><li>比如虚函数，函数调用<br>这些可以通过bolt优化，profile动态优化</li></ul><p>函数对齐： 同样指令也是需要对齐的, 来减少跨cacheline的情况</p><div class="code-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将函数对齐到16字节边界</span></span><br><span class="line"><span class="type">void</span> __attribute__((<span class="built_in">aligned</span>(<span class="number">16</span>))) <span class="built_in">my_function</span>() &#123;</span><br><span class="line">    <span class="comment">// 函数实现</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p><strong>减少指令依赖</strong><br>超线程，两个前端发给一个后端，缺陷在于自己要执行更长时间（往往互相竞争访存指令），好处在于不会出现false sharing问题，线程不用做上下文切换（因为用的是同一套硬件）但是不同的进程的线程竞争会非常严重，超线程切换是一个纯硬件行为，CPU完全自主控制</p><h4 id="后端-1"><a href="#后端-1" class="headerlink" title="后端"></a>后端</h4><p><strong>投机执行</strong> 是让cpu执行更快的根本原因，先执行，再判断结果，分支预测只是取指，但是投机执行会让后端的port被占满</p><h3 id="特殊指令"><a href="#特殊指令" class="headerlink" title="特殊指令"></a>特殊指令</h3><p>像AVX这种向量指令，被广泛用于加速数据处理<br>但是也有缺陷，AVX更多晶体管，并且并行度高，发热量更大，AVX会触发CPU降频，AVX-512影响更明显，CPU降频后影响整体的流水线流转周期，不一定性能更高</p><blockquote><p>20-30%的性能下降</p></blockquote><p>基本用于内存拷贝</p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>空间换时间不一定是最好的选择，因为访存，通信现在成了重要的瓶颈，无论是CPU还是GPU，有的时候多计算一下胜过于多访存</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p>wiki: <a class="link" target="_blank" rel="noopener" href="https://en.wikichip.org/">https://en.wikichip.org/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br><a class="link" target="_blank" rel="noopener" href="https://plantegg.github.io/2021/06/01/CPU%E7%9A%84%E5%88%B6%E9%80%A0%E5%92%8C%E6%A6%82%E5%BF%B5/">CPU<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p></div><div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8"><div class="article-copyright-info-container"><ul><li><strong>Title:</strong> 现代CPU</li><li><strong>Author:</strong> zyu</li><li><strong>Created at :</strong> 2025-10-31 00:00:00</li><li><strong>Updated at :</strong> 2025-11-07 10:21:57</li><li><strong>Link:</strong> https://codezyu.github.io/2025/10/31/Arch/CPU/多核CPU/</li><li><strong>License: </strong>This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.</li></ul></div></div><ul class="post-tags-box text-lg mt-1.5 flex-wrap justify-center flex md:hidden"><li class="tag-item mx-0.5"><a href="/tags/Tech/">#Tech</a>&nbsp;</li><li class="tag-item mx-0.5"><a href="/tags/achitechture/">#achitechture</a>&nbsp;</li><li class="tag-item mx-0.5"><a href="/tags/CPU/">#CPU</a>&nbsp;</li></ul><div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8"><div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2"><a class="prev" rel="prev" href="/2025/11/06/Arch/GPU/%E6%8E%A8%E7%90%86KV%20Cache/"><span class="left arrow-icon flex justify-center items-center"><i class="fa-solid fa-chevron-left"></i> </span><span class="title flex justify-center items-center"><span class="post-nav-title-item truncate max-w-48">推理KV Cache</span> <span class="post-nav-item">Prev posts</span></span></a></div><div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2"><a class="next" rel="next" href="/2025/10/30/Project/bRPC/Google%20Protobuf/"><span class="title flex justify-center items-center"><span class="post-nav-title-item truncate max-w-48">Protobuf</span> <span class="post-nav-item">Next posts</span> </span><span class="right arrow-icon flex justify-center items-center"><i class="fa-solid fa-chevron-right"></i></span></a></div></div><div class="comment-container px-2 sm:px-6 md:px-8 pb-8"><div class="comments-container mt-10 w-full"><div id="comment-anchor" class="w-full h-2.5"></div><div class="comment-area-title w-full my-1.5 md:my-2.5 text-xl md:text-3xl font-bold">Comments</div><div id="waline"></div><script type="module" data-swup-reload-script>import{init}from"/js/libs/waline.js";function loadWaline(){init({el:"#waline",serverURL:"https://example.example.com",dark:'body[class~="dark-mode"]',reaction:!1,requiredMeta:["nick","mail"],emoji:[],lang:"zh-CN"})}"undefined"!=typeof swup?loadWaline():window.addEventListener("DOMContentLoaded",loadWaline)</script></div></div></div><div class="toc-content-container"><div class="post-toc-wrap"><div class="post-toc"><div class="toc-title">On this page</div><div class="page-title">现代CPU</div><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%A4%9A%E6%A0%B8%E4%BA%92%E8%81%94"><span class="nav-text">多核互联</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#SMP"><span class="nav-text">SMP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NUMA"><span class="nav-text">NUMA</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A1%AC%E4%BB%B6"><span class="nav-text">硬件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E4%BA%92%E8%81%94"><span class="nav-text">核心互联</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NUMA%E4%BA%92%E8%81%94"><span class="nav-text">NUMA互联</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NUMA-%E8%AE%BF%E5%AD%98"><span class="nav-text">NUMA 访存</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BC%93%E5%AD%98"><span class="nav-text">缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7"><span class="nav-text">缓存一致性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%AA%E5%85%B1%E4%BA%AB%E9%97%AE%E9%A2%98"><span class="nav-text">伪共享问题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E7%9B%B8%E5%85%B3"><span class="nav-text">缓存相关</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E5%AD%98%E5%82%A8%E7%9A%84%E6%98%AF%E4%BB%80%E4%B9%88%E5%9C%B0%E5%9D%80"><span class="nav-text">缓存存储的是什么地址</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%86%85%E5%AD%98"><span class="nav-text">内存</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#NUMA%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="nav-text">NUMA内存管理</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%95%E6%A0%B8"><span class="nav-text">单核</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%81%E6%B0%B4%E7%BA%BF"><span class="nav-text">流水线</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%8D%E7%AB%AF"><span class="nav-text">前端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%8E%E7%AB%AF"><span class="nav-text">后端</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IPC"><span class="nav-text">IPC</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E6%8F%90%E5%8D%87CPU%E6%80%A7%E8%83%BD"><span class="nav-text">如何提升CPU性能</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8F%90%E9%AB%98%E9%A2%91%E7%8E%87"><span class="nav-text">提高频率</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8F%90%E9%AB%98IPC"><span class="nav-text">提高IPC</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%B9%E6%AE%8A%E6%8C%87%E4%BB%A4"><span class="nav-text">特殊指令</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-text">总结</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-text">参考</span></a></li></ol></div></div></div></div></div></div><div class="main-content-footer"><footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color"><div class="info-container py-3 text-center"><div class="text-center">&copy; <span>2022</span> - 2025&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration:0.5s;color:#f54545"></i>&nbsp;&nbsp;<a href="/">zyu</a><p class="post-count space-x-0.5"><span>15 posts in total</span></p></div><script data-swup-reload-script src="https://cn.vercount.one/js"></script><div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right"><span id="busuanzi_container_site_uv" class="lg:!block"><span class="text-sm">VISITOR COUNT</span> <span id="busuanzi_value_site_uv"></span> </span><span id="busuanzi_container_site_pv" class="lg:!block"><span class="text-sm">TOTAL PAGE VIEWS</span> <span id="busuanzi_value_site_pv"></span></span></div><div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left"><span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span> <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.8.5</a></span></div><div>Blog up for <span class="odometer" id="runtime_days"></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec</div><script data-swup-reload-script>try{function odometer_init(){document.querySelectorAll(".odometer").forEach(e=>{new Odometer({el:e,format:"( ddd).dd",duration:200})})}odometer_init()}catch(e){}</script></div></footer></div></div><div class="post-tools"><div class="post-tools-container"><ul class="article-tools-list"><li class="right-bottom-tools page-aside-toggle"><i class="fa-regular fa-outdent"></i></li><li class="go-comment"><i class="fa-regular fa-comments"></i></li></ul></div></div><div class="right-side-tools-container"><div class="side-tools-container"><ul class="hidden-tools-list"><li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center"><i class="fa-regular fa-magnifying-glass-plus"></i></li><li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center"><i class="fa-regular fa-magnifying-glass-minus"></i></li><li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center"><i class="fa-regular fa-moon"></i></li><li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center"><i class="fa-regular fa-arrow-down"></i></li></ul><ul class="visible-tools-list"><li class="right-bottom-tools toggle-tools-list flex justify-center items-center"><i class="fa-regular fa-cog fa-spin"></i></li><li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center"><i class="arrow-up fas fa-arrow-up"></i> <span class="percent"></span></li></ul></div></div><div class="image-viewer-container"><img src=""></div><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-input-field-pre"><i class="fa-solid fa-keyboard"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="Search..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa-solid fa-times"></i></span></div><div id="search-result"><div id="no-result"><i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i></div></div></div></div></main><script src="/js/build/libs/Swup.min.js"></script><script src="/js/build/libs/SwupSlideTheme.min.js"></script><script src="/js/build/libs/SwupScriptsPlugin.min.js"></script><script src="/js/build/libs/SwupProgressPlugin.min.js"></script><script src="/js/build/libs/SwupScrollPlugin.min.js"></script><script src="/js/build/libs/SwupPreloadPlugin.min.js"></script><script>const swup=new Swup({plugins:[new SwupScriptsPlugin({optin:!0}),new SwupProgressPlugin,new SwupScrollPlugin({offset:80}),new SwupSlideTheme({mainElement:".main-content-body"}),new SwupPreloadPlugin],containers:["#swup"]})</script><script src="/js/build/tools/imageViewer.js" type="module"></script><script src="/js/build/utils.js" type="module"></script><script src="/js/build/main.js" type="module"></script><script src="/js/build/layouts/navbarShrink.js" type="module"></script><script src="/js/build/tools/scrollTopBottom.js" type="module"></script><script src="/js/build/tools/lightDarkSwitch.js" type="module"></script><script src="/js/build/layouts/categoryList.js" type="module"></script><script src="/js/build/tools/localSearch.js" type="module"></script><script src="/js/build/tools/codeBlock.js" type="module"></script><script src="/js/build/layouts/lazyload.js" type="module"></script><script src="/js/build/tools/runtime.js"></script><script src="/js/build/libs/odometer.min.js"></script><link rel="stylesheet" href="/assets/odometer-theme-minimal.css"><script src="/js/build/libs/Typed.min.js"></script><script src="/js/build/plugins/typed.js" type="module"></script><script src="/js/build/libs/mermaid.min.js"></script><script src="/js/build/plugins/mermaid.js"></script><script src="/js/build/libs/anime.min.js"></script><script src="/js/build/tools/tocToggle.js" type="module" data-swup-reload-script=""></script><script src="/js/build/layouts/toc.js" type="module" data-swup-reload-script=""></script><script src="/js/build/plugins/tabs.js" type="module" data-swup-reload-script=""></script><script src="/js/build/libs/moment-with-locales.min.js" data-swup-reload-script=""></script><script src="/js/build/layouts/essays.js" type="module" data-swup-reload-script=""></script><div id="aplayer"></div><script src="/js/build/libs/APlayer.min.js"></script><script src="/js/build/plugins/aplayer.js"></script></body></html>